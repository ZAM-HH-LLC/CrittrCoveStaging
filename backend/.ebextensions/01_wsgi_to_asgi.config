option_settings:
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: zenexotics_backend.settings
    PYTHONPATH: /var/app/current/zenexotics_backend

  aws:elasticbeanstalk:container:python:
    WSGIPath: zenexotics_backend.asgi:application

  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx

files:
  "/etc/nginx/conf.d/proxy.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # WebSocket support
      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }
      
      upstream websocket {
        server unix:///var/run/daphne.sock;
      }
      
      server {
        listen 80;
        
        # Regular HTTP requests
        location / {
          proxy_pass http://unix:///var/run/daphne.sock;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_redirect off;
        }
        
        # WebSocket connections
        location /ws/ {
          proxy_pass http://unix:///var/run/daphne.sock;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_read_timeout 86400;  # Timeout for WebSocket connections (24h)
        }
        
        # Static files
        location /static/ {
          alias /var/app/current/zenexotics_backend/static/;
        }
        
        # Media files
        location /media/ {
          alias /var/app/current/zenexotics_backend/media/;
        }
      }

  "/opt/elasticbeanstalk/hooks/appdeploy/post/01_start_daphne.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Switch to app directory
      cd /var/app/current
      
      # Make sure our socket directory exists
      mkdir -p /var/run
      
      # Kill any existing Daphne processes
      if [ -f /var/run/daphne.pid ]; then
        kill -9 $(cat /var/run/daphne.pid) || true
        rm -f /var/run/daphne.pid
      fi
      
      # Start Daphne with the app's virtualenv
      source /var/app/venv/*/bin/activate
      daphne -u /var/run/daphne.sock zenexotics_backend.asgi:application --access-log /var/log/daphne-access.log --pid /var/run/daphne.pid --proxy-headers &
      
      # Set proper permissions for the socket
      chown wsgi:wsgi /var/run/daphne.sock
      
      exit 0

container_commands:
  01_install_daphne:
    command: "source /var/app/venv/*/bin/activate && pip install daphne"

  02_collect_static:
    command: "source /var/app/venv/*/bin/activate && python manage.py collectstatic --noinput"
    
  03_create_socket_dir:
    command: "mkdir -p /var/run && chmod 755 /var/run" 