packages:
  yum:
    gcc-c++: []
    make: []

files:
  "/etc/redis.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      daemonize yes
      pidfile /var/run/redis/redis.pid
      port 6379
      timeout 0
      loglevel notice
      logfile /var/log/redis.log
      databases 16
      save 900 1
      save 300 10
      save 60 10000
      rdbcompression yes
      dbfilename dump.rdb
      dir /var/lib/redis
      appendonly no
      maxmemory 256mb
      maxmemory-policy allkeys-lru
  
  "/opt/elasticbeanstalk/hooks/appdeploy/post/02_start_redis.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Create Redis directories if they don't exist
      mkdir -p /var/lib/redis
      mkdir -p /var/run/redis
      
      # Set permissions
      chown -R redis:redis /var/lib/redis
      chown -R redis:redis /var/run/redis
      
      # Restart Redis
      service redis restart
      
      # Set Redis to start on boot
      chkconfig redis on
      
      exit 0

commands:
  01_install_redis:
    command: |
      if [ ! -f /usr/bin/redis-server ]; then
        amazon-linux-extras install redis6 -y
      fi

container_commands:
  01_update_redis_environment:
    command: "sed -i 's/^REDIS_URL=.*/REDIS_URL=redis:\\/\\/localhost:6379\\/0/' /opt/elasticbeanstalk/deployment/env" 